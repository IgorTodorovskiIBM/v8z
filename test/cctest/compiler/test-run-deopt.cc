// Copyright 2014 the V8 project authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#include "src/v8.h"

#include "test/cctest/compiler/function-tester.h"

using namespace v8::internal;
using namespace v8::internal::compiler;

#if V8_TURBOFAN_TARGET

TEST(TurboSimpleDeopt) {
  FLAG_allow_natives_syntax = true;
  FLAG_turbo_deoptimization = true;

  FunctionTester T(
      "\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x66\x28\x61\x29\x20\x7b"
      "\x76\x61\x72\x20\x62\x20\x3d\x20\x31\x3b"
      "\x69\x66\x20\x28\x21\x25\x49\x73\x4f\x70\x74\x69\x6d\x69\x7a\x65\x64\x28\x29\x29\x20\x72\x65\x74\x75\x72\x6e\x20\x30\x3b"
      "\x25\x44\x65\x6f\x70\x74\x69\x6d\x69\x7a\x65\x46\x75\x6e\x63\x74\x69\x6f\x6e\x28\x66\x29\x3b"
      "\x69\x66\x20\x28\x25\x49\x73\x4f\x70\x74\x69\x6d\x69\x7a\x65\x64\x28\x29\x29\x20\x72\x65\x74\x75\x72\x6e\x20\x30\x3b"
      "\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2b\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(2), T.Val(1));
}


TEST(TurboSimpleDeoptInExpr) {
  FLAG_allow_natives_syntax = true;
  FLAG_turbo_deoptimization = true;

  FunctionTester T(
      "\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x66\x28\x61\x29\x20\x7b"
      "\x76\x61\x72\x20\x62\x20\x3d\x20\x31\x3b"
      "\x76\x61\x72\x20\x63\x20\x3d\x20\x32\x3b"
      "\x69\x66\x20\x28\x21\x25\x49\x73\x4f\x70\x74\x69\x6d\x69\x7a\x65\x64\x28\x29\x29\x20\x72\x65\x74\x75\x72\x6e\x20\x30\x3b"
      "\x76\x61\x72\x20\x64\x20\x3d\x20\x62\x20\x2b\x20\x28\x25\x44\x65\x6f\x70\x74\x69\x6d\x69\x7a\x65\x46\x75\x6e\x63\x74\x69\x6f\x6e\x28\x66\x29\x2c\x20\x63\x29\x3b"
      "\x69\x66\x20\x28\x25\x49\x73\x4f\x70\x74\x69\x6d\x69\x7a\x65\x64\x28\x29\x29\x20\x72\x65\x74\x75\x72\x6e\x20\x30\x3b"
      "\x72\x65\x74\x75\x72\x6e\x20\x64\x20\x2b\x20\x61\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(6), T.Val(3));
}

#endif

TEST(TurboTrivialDeopt) {
  FLAG_allow_natives_syntax = true;
  FLAG_turbo_deoptimization = true;

  FunctionTester T(
      "\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x66\x6f\x6f\x28\x29\x20\x7b"
      "\x25\x44\x65\x6f\x70\x74\x69\x6d\x69\x7a\x65\x46\x75\x6e\x63\x74\x69\x6f\x6e\x28\x66\x6f\x6f\x29\x3b"
      "\x72\x65\x74\x75\x72\x6e\x20\x31\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(1));
}
