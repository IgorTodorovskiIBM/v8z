// Copyright 2014 the V8 project authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#include "src/v8.h"

#include "test/cctest/compiler/function-tester.h"

using namespace v8::internal;
using namespace v8::internal::compiler;

TEST(BinopAdd) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2b\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(3, 1, 2);
  T.CheckCall(-11, -2, -9);
  T.CheckCall(-11, -1.5, -9.5);
  T.CheckCall(T.Val("\x41\x42"), T.Val("\x41"), T.Val("\x42"));
  T.CheckCall(T.Val("\x41\x31\x31"), T.Val("\x41"), T.Val(11));
  T.CheckCall(T.Val("\x31\x32\x42"), T.Val(12), T.Val("\x42"));
  T.CheckCall(T.Val("\x33\x38"), T.Val("\x33"), T.Val("\x38"));
  T.CheckCall(T.Val("\x33\x31"), T.Val("\x33"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckCall(T.Val("\x33\x5b\x6f\x62\x6a\x65\x63\x74\x20\x4f\x62\x6a\x65\x63\x74\x5d"), T.Val("\x33"), T.NewObject("\x28\x7b\x7d\x29"));
}


TEST(BinopSubtract) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2d\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(3, 4, 1);
  T.CheckCall(3.0, 4.5, 1.5);
  T.CheckCall(T.Val(-9), T.Val("\x30"), T.Val(9));
  T.CheckCall(T.Val(-9), T.Val(0.0), T.Val("\x39"));
  T.CheckCall(T.Val(1), T.Val("\x33"), T.Val("\x32"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.Val("\x42"));
  T.CheckCall(T.Val(2), T.Val("\x33"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.NewObject("\x28\x7b\x7d\x29"));
}


TEST(BinopMultiply) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2a\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(6, 3, 2);
  T.CheckCall(4.5, 2.0, 2.25);
  T.CheckCall(T.Val(6), T.Val("\x33"), T.Val(2));
  T.CheckCall(T.Val(4.5), T.Val(2.0), T.Val("\x32\x2e\x32\x35"));
  T.CheckCall(T.Val(6), T.Val("\x33"), T.Val("\x32"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.Val("\x42"));
  T.CheckCall(T.Val(3), T.Val("\x33"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.NewObject("\x28\x7b\x7d\x29"));
}


TEST(BinopDivide) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2f\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(2, 8, 4);
  T.CheckCall(2.1, 8.4, 4);
  T.CheckCall(V8_INFINITY, 8, 0);
  T.CheckCall(-V8_INFINITY, -8, 0);
  T.CheckCall(T.infinity(), T.Val(8), T.Val("\x30"));
  T.CheckCall(T.minus_infinity(), T.Val("\x2d\x38"), T.Val(0.0));
  T.CheckCall(T.Val(1.5), T.Val("\x33"), T.Val("\x32"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.Val("\x42"));
  T.CheckCall(T.Val(1.5), T.Val("\x33"), T.NewObject("\x28\x5b\x32\x5d\x29"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.NewObject("\x28\x7b\x7d\x29"));
}


TEST(BinopModulus) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x25\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(3, 8, 5);
  T.CheckCall(T.Val(3), T.Val("\x38"), T.Val(5));
  T.CheckCall(T.Val(3), T.Val(8), T.Val("\x35"));
  T.CheckCall(T.Val(1), T.Val("\x33"), T.Val("\x32"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.Val("\x42"));
  T.CheckCall(T.Val(1), T.Val("\x33"), T.NewObject("\x28\x5b\x32\x5d\x29"));
  T.CheckCall(T.nan(), T.Val("\x33"), T.NewObject("\x28\x7b\x7d\x29"));
}


TEST(BinopShiftLeft) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3c\x3c\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(4, 2, 1);
  T.CheckCall(T.Val(4), T.Val("\x32"), T.Val(1));
  T.CheckCall(T.Val(4), T.Val(2), T.Val("\x31"));
}


TEST(BinopShiftRight) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3e\x3e\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(4, 8, 1);
  T.CheckCall(-4, -8, 1);
  T.CheckCall(T.Val(4), T.Val("\x38"), T.Val(1));
  T.CheckCall(T.Val(4), T.Val(8), T.Val("\x31"));
}


TEST(BinopShiftRightLogical) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3e\x3e\x3e\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(4, 8, 1);
  T.CheckCall(0x7ffffffc, -8, 1);
  T.CheckCall(T.Val(4), T.Val("\x38"), T.Val(1));
  T.CheckCall(T.Val(4), T.Val(8), T.Val("\x31"));
}


TEST(BinopAnd) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x26\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(7, 7, 15);
  T.CheckCall(7, 15, 7);
  T.CheckCall(T.Val(7), T.Val("\x31\x35"), T.Val(7));
  T.CheckCall(T.Val(7), T.Val(15), T.Val("\x37"));
}


TEST(BinopOr) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x7c\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(6, 4, 2);
  T.CheckCall(6, 2, 4);
  T.CheckCall(T.Val(6), T.Val("\x32"), T.Val(4));
  T.CheckCall(T.Val(6), T.Val(2), T.Val("\x34"));
}


TEST(BinopXor) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x5e\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(7, 15, 8);
  T.CheckCall(7, 8, 15);
  T.CheckCall(T.Val(7), T.Val("\x38"), T.Val(15));
  T.CheckCall(T.Val(7), T.Val(8), T.Val("\x31\x35"));
}


TEST(BinopStrictEqual) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3d\x3d\x3d\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(7, 7);
  T.CheckFalse(7, 8);
  T.CheckTrue(7.1, 7.1);
  T.CheckFalse(7.1, 8.1);

  T.CheckTrue(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7), T.undefined());
  T.CheckFalse(T.undefined(), T.Val(7));

  CompileRun("\x76\x61\x72\x20\x6f\x20\x3d\x20\x7b\x20\x64\x65\x73\x63\x20\x3a\x20\x27\x49\x20\x61\x6d\x20\x61\x20\x73\x69\x6e\x67\x6c\x65\x74\x6f\x6e\x27\x20\x7d");
  T.CheckFalse(T.NewObject("\x28\x5b\x31\x5d\x29"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckFalse(T.NewObject("\x28\x7b\x7d\x29"), T.NewObject("\x28\x7b\x7d\x29"));
  T.CheckTrue(T.NewObject("\x28\x6f\x29"), T.NewObject("\x28\x6f\x29"));
}


TEST(BinopEqual) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3d\x3d\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(7, 7);
  T.CheckFalse(7, 8);
  T.CheckTrue(7.1, 7.1);
  T.CheckFalse(7.1, 8.1);

  T.CheckTrue(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x37\x2e\x31"));

  CompileRun("\x76\x61\x72\x20\x6f\x20\x3d\x20\x7b\x20\x64\x65\x73\x63\x20\x3a\x20\x27\x49\x20\x61\x6d\x20\x61\x20\x73\x69\x6e\x67\x6c\x65\x74\x6f\x6e\x27\x20\x7d");
  T.CheckFalse(T.NewObject("\x28\x5b\x31\x5d\x29"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckFalse(T.NewObject("\x28\x7b\x7d\x29"), T.NewObject("\x28\x7b\x7d\x29"));
  T.CheckTrue(T.NewObject("\x28\x6f\x29"), T.NewObject("\x28\x6f\x29"));
}


TEST(BinopNotEqual) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x21\x3d\x20\x62\x3b\x20\x7d\x29");

  T.CheckFalse(7, 7);
  T.CheckTrue(7, 8);
  T.CheckFalse(7.1, 7.1);
  T.CheckTrue(7.1, 8.1);

  T.CheckFalse(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x37\x2e\x31"));

  CompileRun("\x76\x61\x72\x20\x6f\x20\x3d\x20\x7b\x20\x64\x65\x73\x63\x20\x3a\x20\x27\x49\x20\x61\x6d\x20\x61\x20\x73\x69\x6e\x67\x6c\x65\x74\x6f\x6e\x27\x20\x7d");
  T.CheckTrue(T.NewObject("\x28\x5b\x31\x5d\x29"), T.NewObject("\x28\x5b\x31\x5d\x29"));
  T.CheckTrue(T.NewObject("\x28\x7b\x7d\x29"), T.NewObject("\x28\x7b\x7d\x29"));
  T.CheckFalse(T.NewObject("\x28\x6f\x29"), T.NewObject("\x28\x6f\x29"));
}


TEST(BinopLessThan) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3c\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(7, 8);
  T.CheckFalse(8, 7);
  T.CheckTrue(-8.1, -8);
  T.CheckFalse(-8, -8.1);
  T.CheckFalse(0.111, 0.111);

  T.CheckFalse(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x36\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x37\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x38\x2e\x31"));
}


TEST(BinopLessThanEqual) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3c\x3d\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(7, 8);
  T.CheckFalse(8, 7);
  T.CheckTrue(-8.1, -8);
  T.CheckFalse(-8, -8.1);
  T.CheckTrue(0.111, 0.111);

  T.CheckTrue(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x36\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x37\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x38\x2e\x31"));
}


TEST(BinopGreaterThan) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3e\x20\x62\x3b\x20\x7d\x29");

  T.CheckFalse(7, 8);
  T.CheckTrue(8, 7);
  T.CheckFalse(-8.1, -8);
  T.CheckTrue(-8, -8.1);
  T.CheckFalse(0.111, 0.111);

  T.CheckFalse(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x36\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x38\x2e\x31"));
}


TEST(BinopGreaterThanOrEqual) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x3e\x3d\x20\x62\x3b\x20\x7d\x29");

  T.CheckFalse(7, 8);
  T.CheckTrue(8, 7);
  T.CheckFalse(-8.1, -8);
  T.CheckTrue(-8, -8.1);
  T.CheckTrue(0.111, 0.111);

  T.CheckTrue(T.Val("\x37\x2e\x31"), T.Val("\x37\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x36\x2e\x31"));
  T.CheckTrue(T.Val(7.1), T.Val("\x37\x2e\x31"));
  T.CheckFalse(T.Val(7.1), T.Val("\x38\x2e\x31"));
}


TEST(BinopIn) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x69\x6e\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(T.Val("\x78"), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"));
  T.CheckFalse(T.Val("\x79"), T.NewObject("\x28\x7b\x78\x3a\x34\x32\x7d\x29"));
  T.CheckFalse(T.Val(123), T.NewObject("\x28\x7b\x78\x3a\x36\x35\x7d\x29"));
  T.CheckTrue(T.Val(1), T.NewObject("\x28\x5b\x31\x2c\x32\x2c\x33\x5d\x29"));
}


TEST(BinopInstanceOf) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x69\x6e\x73\x74\x61\x6e\x63\x65\x6f\x66\x20\x62\x3b\x20\x7d\x29");

  T.CheckTrue(T.NewObject("\x28\x6e\x65\x77\x20\x4e\x75\x6d\x62\x65\x72\x28\x32\x33\x29\x29"), T.NewObject("\x4e\x75\x6d\x62\x65\x72"));
  T.CheckFalse(T.NewObject("\x28\x6e\x65\x77\x20\x4e\x75\x6d\x62\x65\x72\x28\x32\x33\x29\x29"), T.NewObject("\x53\x74\x72\x69\x6e\x67"));
  T.CheckFalse(T.NewObject("\x28\x6e\x65\x77\x20\x53\x74\x72\x69\x6e\x67\x28\x27\x61\x27\x29\x29"), T.NewObject("\x4e\x75\x6d\x62\x65\x72"));
  T.CheckTrue(T.NewObject("\x28\x6e\x65\x77\x20\x53\x74\x72\x69\x6e\x67\x28\x27\x62\x27\x29\x29"), T.NewObject("\x53\x74\x72\x69\x6e\x67"));
  T.CheckFalse(T.Val(1), T.NewObject("\x4e\x75\x6d\x62\x65\x72"));
  T.CheckFalse(T.Val("\x61\x62\x63"), T.NewObject("\x53\x74\x72\x69\x6e\x67"));

  CompileRun("\x76\x61\x72\x20\x62\x6f\x75\x6e\x64\x20\x3d\x20\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x20\x7b\x7d\x29\x2e\x62\x69\x6e\x64\x28\x75\x6e\x64\x65\x66\x69\x6e\x65\x64\x29");
  T.CheckTrue(T.NewObject("\x28\x6e\x65\x77\x20\x62\x6f\x75\x6e\x64\x28\x29\x29"), T.NewObject("\x62\x6f\x75\x6e\x64"));
  T.CheckTrue(T.NewObject("\x28\x6e\x65\x77\x20\x62\x6f\x75\x6e\x64\x28\x29\x29"), T.NewObject("\x4f\x62\x6a\x65\x63\x74"));
  T.CheckFalse(T.NewObject("\x28\x6e\x65\x77\x20\x62\x6f\x75\x6e\x64\x28\x29\x29"), T.NewObject("\x4e\x75\x6d\x62\x65\x72"));
}


TEST(UnopNot) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x21\x61\x3b\x20\x7d\x29");

  T.CheckCall(T.true_value(), T.false_value(), T.undefined());
  T.CheckCall(T.false_value(), T.true_value(), T.undefined());
  T.CheckCall(T.true_value(), T.Val(0.0), T.undefined());
  T.CheckCall(T.false_value(), T.Val(123), T.undefined());
  T.CheckCall(T.false_value(), T.Val("\x78"), T.undefined());
  T.CheckCall(T.true_value(), T.undefined(), T.undefined());
  T.CheckCall(T.true_value(), T.nan(), T.undefined());
}


TEST(UnopCountPost) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x2b\x2b\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(0.0), T.Val(0.0), T.undefined());
  T.CheckCall(T.Val(2.3), T.Val(2.3), T.undefined());
  T.CheckCall(T.Val(123), T.Val(123), T.undefined());
  T.CheckCall(T.Val(7), T.Val("\x37"), T.undefined());
  T.CheckCall(T.nan(), T.Val("\x78"), T.undefined());
  T.CheckCall(T.nan(), T.undefined(), T.undefined());
  T.CheckCall(T.Val(1.0), T.true_value(), T.undefined());
  T.CheckCall(T.Val(0.0), T.false_value(), T.undefined());
  T.CheckCall(T.nan(), T.nan(), T.undefined());
}


TEST(UnopCountPre) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x2b\x2b\x61\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(1.0), T.Val(0.0), T.undefined());
  T.CheckCall(T.Val(3.3), T.Val(2.3), T.undefined());
  T.CheckCall(T.Val(124), T.Val(123), T.undefined());
  T.CheckCall(T.Val(8), T.Val("\x37"), T.undefined());
  T.CheckCall(T.nan(), T.Val("\x78"), T.undefined());
  T.CheckCall(T.nan(), T.undefined(), T.undefined());
  T.CheckCall(T.Val(2.0), T.true_value(), T.undefined());
  T.CheckCall(T.Val(1.0), T.false_value(), T.undefined());
  T.CheckCall(T.nan(), T.nan(), T.undefined());
}


TEST(PropertyNamedLoad) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(23), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.undefined());
  T.CheckCall(T.undefined(), T.NewObject("\x28\x7b\x79\x3a\x32\x33\x7d\x29"), T.undefined());
}


TEST(PropertyKeyedLoad) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x5b\x62\x5d\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(23), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.Val("\x78"));
  T.CheckCall(T.Val(42), T.NewObject("\x28\x5b\x32\x33\x2c\x34\x32\x2c\x36\x35\x5d\x29"), T.Val(1));
  T.CheckCall(T.undefined(), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.Val("\x79"));
  T.CheckCall(T.undefined(), T.NewObject("\x28\x5b\x32\x33\x2c\x34\x32\x2c\x36\x35\x5d\x29"), T.Val(4));
}


TEST(PropertyNamedStore) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x61\x2e\x78\x20\x3d\x20\x37\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(7), T.NewObject("\x28\x7b\x7d\x29"), T.undefined());
  T.CheckCall(T.Val(7), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.undefined());
}


TEST(PropertyKeyedStore) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x61\x5b\x62\x5d\x20\x3d\x20\x37\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(7), T.NewObject("\x28\x7b\x7d\x29"), T.Val("\x78"));
  T.CheckCall(T.Val(7), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.Val("\x78"));
  T.CheckCall(T.Val(9), T.NewObject("\x28\x7b\x78\x3a\x39\x7d\x29"), T.Val("\x79"));
}


TEST(PropertyNamedDelete) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x64\x65\x6c\x65\x74\x65\x20\x61\x2e\x78\x3b\x20\x7d\x29");

  CompileRun("\x76\x61\x72\x20\x6f\x20\x3d\x20\x4f\x62\x6a\x65\x63\x74\x2e\x63\x72\x65\x61\x74\x65\x28\x7b\x7d\x2c\x20\x7b\x20\x78\x3a\x20\x7b\x20\x76\x61\x6c\x75\x65\x3a\x32\x33\x20\x7d\x20\x7d\x29\x3b");
  T.CheckTrue(T.NewObject("\x28\x7b\x78\x3a\x34\x32\x7d\x29"), T.undefined());
  T.CheckTrue(T.NewObject("\x28\x7b\x7d\x29"), T.undefined());
  T.CheckFalse(T.NewObject("\x28\x6f\x29"), T.undefined());
}


TEST(PropertyKeyedDelete) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x20\x62\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x64\x65\x6c\x65\x74\x65\x20\x61\x5b\x62\x5d\x3b\x20\x7d\x29");

  CompileRun("\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x67\x65\x74\x58\x28\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x27\x78\x27\x3b\x20\x7d");
  CompileRun("\x76\x61\x72\x20\x6f\x20\x3d\x20\x4f\x62\x6a\x65\x63\x74\x2e\x63\x72\x65\x61\x74\x65\x28\x7b\x7d\x2c\x20\x7b\x20\x78\x3a\x20\x7b\x20\x76\x61\x6c\x75\x65\x3a\x32\x33\x20\x7d\x20\x7d\x29\x3b");
  T.CheckTrue(T.NewObject("\x28\x7b\x78\x3a\x34\x32\x7d\x29"), T.Val("\x78"));
  T.CheckFalse(T.NewObject("\x28\x6f\x29"), T.Val("\x78"));
  T.CheckFalse(T.NewObject("\x28\x6f\x29"), T.NewObject("\x28\x7b\x74\x6f\x53\x74\x72\x69\x6e\x67\x3a\x67\x65\x74\x58\x7d\x29"));
}


TEST(GlobalLoad) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x67\x3b\x20\x7d\x29");

  T.CheckThrows(T.undefined(), T.undefined());
  CompileRun("\x76\x61\x72\x20\x67\x20\x3d\x20\x32\x33\x3b");
  T.CheckCall(T.Val(23));
}


TEST(GlobalStoreSloppy) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x67\x20\x3d\x20\x61\x20\x2b\x20\x62\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x67\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(33), T.Val(22), T.Val(11));
  CompileRun("\x64\x65\x6c\x65\x74\x65\x20\x67");
  CompileRun("\x63\x6f\x6e\x73\x74\x20\x67\x20\x3d\x20\x32\x33");
  T.CheckCall(T.Val(23), T.Val(55), T.Val(44));
}


TEST(GlobalStoreStrict) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x27\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x27\x3b\x20\x67\x20\x3d\x20\x61\x20\x2b\x20\x62\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x67\x3b\x20\x7d\x29");

  T.CheckThrows(T.Val(22), T.Val(11));
  CompileRun("\x76\x61\x72\x20\x67\x20\x3d\x20\x27\x61\x20\x67\x6c\x6f\x62\x61\x6c\x20\x76\x61\x72\x69\x61\x62\x6c\x65\x27\x3b");
  T.CheckCall(T.Val(33), T.Val(22), T.Val(11));
}


TEST(ContextLoad) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x7b\x61\x7d\x29\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x61\x20\x2b\x20\x62\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(65), T.Val(23), T.Val(42));
  T.CheckCall(T.Val("\x61\x62"), T.Val("\x61"), T.Val("\x62"));
}


TEST(ContextStore) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x7b\x78\x7d\x29\x3b\x20\x76\x61\x72\x20\x78\x20\x3d\x20\x61\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(23), T.Val(23), T.undefined());
  T.CheckCall(T.Val("\x61"), T.Val("\x61"), T.undefined());
}


TEST(LookupLoad) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x77\x69\x74\x68\x28\x61\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x78\x20\x2b\x20\x62\x3b\x20\x7d\x20\x7d\x29");

  T.CheckCall(T.Val(24), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.Val(1));
  T.CheckCall(T.Val(32), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x2c\x20\x62\x3a\x39\x7d\x29"), T.Val(2));
  T.CheckCall(T.Val(45), T.NewObject("\x28\x7b\x5f\x5f\x70\x72\x6f\x74\x6f\x5f\x5f\x3a\x7b\x78\x3a\x34\x32\x7d\x7d\x29"), T.Val(3));
  T.CheckCall(T.Val(69), T.NewObject("\x28\x7b\x67\x65\x74\x20\x78\x28\x29\x20\x7b\x20\x72\x65\x74\x75\x72\x6e\x20\x36\x35\x3b\x20\x7d\x7d\x29"), T.Val(4));
}


TEST(LookupStore) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x76\x61\x72\x20\x78\x3b\x20\x77\x69\x74\x68\x28\x61\x29\x20\x7b\x20\x78\x20\x3d\x20\x62\x3b\x20\x7d\x20\x72\x65\x74\x75\x72\x6e\x20\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.undefined(), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.Val(1));
  T.CheckCall(T.Val(2), T.NewObject("\x28\x7b\x79\x3a\x32\x33\x7d\x29"), T.Val(2));
  T.CheckCall(T.Val(23), T.NewObject("\x28\x7b\x62\x3a\x32\x33\x7d\x29"), T.Val(3));
  T.CheckCall(T.undefined(), T.NewObject("\x28\x7b\x5f\x5f\x70\x72\x6f\x74\x6f\x5f\x5f\x3a\x7b\x78\x3a\x34\x32\x7d\x7d\x29"), T.Val(4));
}


TEST(BlockLoadStore) {
  FLAG_harmony_scoping = true;
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x27\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x27\x3b\x20\x7b\x20\x6c\x65\x74\x20\x78\x20\x3d\x20\x61\x2b\x61\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x78\x3b\x20\x7d\x7d\x29");

  T.CheckCall(T.Val(46), T.Val(23));
  T.CheckCall(T.Val("\x61\x61"), T.Val("\x61"));
}


TEST(BlockLoadStoreNested) {
  FLAG_harmony_scoping = true;
  const char* src =
      "\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b"
      "\x27\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x27\x3b"
      "\x7b\x20\x6c\x65\x74\x20\x78\x20\x3d\x20\x61\x2c\x20\x79\x20\x3d\x20\x61\x3b"
      "\x20\x20\x7b\x20\x6c\x65\x74\x20\x79\x20\x3d\x20\x62\x3b"
      "\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x78\x20\x2b\x20\x79\x3b"
      "\x20\x20\x7d"
      "\x7d\x7d\x29";
  FunctionTester T(src);

  T.CheckCall(T.Val(65), T.Val(23), T.Val(42));
  T.CheckCall(T.Val("\x61\x62"), T.Val("\x61"), T.Val("\x62"));
}


TEST(ObjectLiteralComputed) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x6f\x20\x3d\x20\x7b\x20\x78\x3a\x61\x2b\x62\x20\x7d\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(65), T.Val(23), T.Val(42));
  T.CheckCall(T.Val("\x61\x62"), T.Val("\x61"), T.Val("\x62"));
}


TEST(ObjectLiteralNonString) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x6f\x20\x3d\x20\x7b\x20\x37\x3a\x61\x2b\x62\x20\x7d\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x5b\x37\x5d\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(65), T.Val(23), T.Val(42));
  T.CheckCall(T.Val("\x61\x62"), T.Val("\x61"), T.Val("\x62"));
}


TEST(ObjectLiteralPrototype) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x6f\x20\x3d\x20\x7b\x20\x5f\x5f\x70\x72\x6f\x74\x6f\x5f\x5f\x3a\x61\x20\x7d\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(23), T.NewObject("\x28\x7b\x78\x3a\x32\x33\x7d\x29"), T.undefined());
  T.CheckCall(T.undefined(), T.NewObject("\x28\x7b\x79\x3a\x34\x32\x7d\x29"), T.undefined());
}


TEST(ObjectLiteralGetter) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x6f\x20\x3d\x20\x7b\x20\x67\x65\x74\x20\x78\x28\x29\x20\x7b\x72\x65\x74\x75\x72\x6e\x20\x61\x7d\x20\x7d\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x2e\x78\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(23), T.Val(23), T.undefined());
  T.CheckCall(T.Val("\x78"), T.Val("\x78"), T.undefined());
}


TEST(ArrayLiteral) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x2c\x62\x29\x20\x7b\x20\x6f\x20\x3d\x20\x5b\x31\x2c\x20\x61\x20\x2b\x20\x62\x2c\x20\x33\x5d\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x5b\x31\x5d\x3b\x20\x7d\x29");

  T.CheckCall(T.Val(65), T.Val(23), T.Val(42));
  T.CheckCall(T.Val("\x61\x62"), T.Val("\x61"), T.Val("\x62"));
}


TEST(RegExpLiteral) {
  FunctionTester T("\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x61\x29\x20\x7b\x20\x6f\x20\x3d\x20\x2f\x62\x2f\x3b\x20\x72\x65\x74\x75\x72\x6e\x20\x6f\x2e\x74\x65\x73\x74\x28\x61\x29\x3b\x20\x7d\x29");

  T.CheckTrue(T.Val("\x61\x62\x63"));
  T.CheckFalse(T.Val("\x78\x79\x7a"));
}
